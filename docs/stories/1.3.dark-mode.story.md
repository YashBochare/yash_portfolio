# Story 1.3: Implement Dark/Light Mode Context & Toggle

## Status
Done

## Story
**As a** Developer,
**I want** A functional dark mode toggle with persistent user preference,
**so that** Users can switch between light and dark themes and have their choice remembered

## Acceptance Criteria
1. ThemeContext with localStorage persistence
2. ThemeToggle component with sun/moon icons
3. No flash of wrong theme on load
4. System preference detection

## Tasks / Subtasks
- [x] Task 1: Create ThemeContext (AC: 1, 4)
  - [x] Create `src/context/ThemeContext.jsx` with `ThemeContext` and `ThemeProvider`
  - [x] Implement state initialization logic:
    - Check `localStorage` for saved theme
    - If none, check `window.matchMedia('(prefers-color-scheme: dark)')`
    - Default to system preference or 'light'
  - [x] Implement `toggleTheme` function
  - [x] Effect hook to add/remove `dark` class from `document.documentElement`
  - [x] Effect hook to save preference to `localStorage`
- [x] Task 2: Create ThemeToggle Component (AC: 2)
  - [x] Create `src/components/common/ThemeToggle.jsx`
  - [x] Consume `ThemeContext`
  - [x] Render a button that toggles theme on click
  - [x] Display Sun icon for Light mode, Moon icon for Dark mode (use icons from chosen lib)
  - [x] Add accessible aria-label
- [x] Task 3: Integrate Provider (AC: 3)
  - [x] Wrap application root (in `main.jsx` or `App.jsx`) with `ThemeProvider`
  - [x] Ensure the script runs early enough or uses layout effect to prevent flash (though React hydration might cause slight flicker, initial class setting in `index.html` head script is the robust "no flash" solution, but Context-based is often acceptable for SPA MVP). *Dev Note: For true "no-flash", add a small inline script in `index.html`.*
- [x] Task 4: Integrate Toggle in UI
  - [x] Add `ThemeToggle` to `Navbar.jsx`
  - [x] Verify functionality and persistence on reload

## Dev Notes
- **Context API/Pattern**: Standard React Context Provider pattern. [Source: docs/front-end-architecture.md#implementation-patterns]
- **Tailwind Config**: Ensure `darkMode: 'class'` is set (done in Story 1.1).
- **Icons**: Sun/Moon icons needed. Can use `lucide-react` or similar.
- **Persistence**: Key name should be consistent, e.g., `'portfolio-theme'`.
- **Flash of Unstyled Content (FOUC)**: To strictly meet "No flash" AC, consider adding a blocking script in `index.html` <head> that checks localStorage/system pref and adds the class before React mounts.
  ```html
  <script>
    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark')
    } else {
      document.documentElement.classList.remove('dark')
    }
  </script>
  ```

### Testing
- **Test File Location**: `src/context/__tests__/ThemeContext.test.jsx`
- **Standards**: Test that toggling changes the class on document element. Test that localStorage is updated.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2026-01-07 | 1.0 | Initial Draft | Scrum Master |
| 2026-01-07 | 1.1 | Implemented Context/Toggle | Dev Agent |

## Dev Agent Record

### Agent Model Used
Antigravity

### Debug Log References
None

### Completion Notes List
- Implemented `ThemeContext` with FOUC prevention logic
- Added inline script to `index.html`
- Created `ThemeToggle` with Lucide icons
- Integrated into `main.jsx` and `Navbar.jsx`

### File List
- src/context/ThemeContext.jsx
- src/components/common/ThemeToggle.jsx
- src/components/layout/Navbar.jsx
- src/main.jsx
- index.html

## QA Results
### Review Date: 2026-01-07
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Implementation effectively handles React hydration/FOUC issues. Hook logic is sound.

### Refactoring Performed
- **File**: `src/context/ThemeContext.jsx`
  - **Change**: Added ESLint disable for HMR rule.
  - **Why**: Prevent lint error for valid hook export pattern.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- All ACs Met: [✓]

### Gate Status
Gate: PASS → docs/qa/gates/1.3.dark-mode.yml

### Recommended Status
[✓ Ready for Done]
